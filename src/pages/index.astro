---
import Layout from "../layouts/Layout.astro";
import Hotspot from "../components/Hotspot.astro";
import Overlay from "../components/Overlay.astro";

import ProjectsContent from "../components/panels/ProjectsContent.astro";
import AboutContent from "../components/panels/AboutContent.astro";
import ContactContent from "../components/panels/ContactContent.astro";
import TodoContent from "../components/panels/TodoContent.astro";
import KeyboardContent from "../components/panels/KeyboardContent.astro";
---

<Layout title="Sehaz at desk">
	<div
		class="relative flex-1 w-full min-h-[60vh] md:h-full overflow-hidden"
		id="desk-container"
	>
		<!-- Desktop Corner UI Overlays (Editorial Brutalism) -->
		<div
			id="ui-overlay"
			class="hidden md:block fixed inset-0 pointer-events-none z-30 p-10 text-primary opacity-0 animate-[fadeIn_1s_ease-out_forwards] animation-delay-500"
			style="transition: color 2000ms cubic-bezier(0.45,0.05,0.55,0.95), opacity 1800ms ease;"
		>
			<!-- Bottom Area Wrapper -->
			<div
				class="absolute bottom-10 left-10 right-10 flex justify-between items-end pointer-events-auto"
			>
				<!-- Bottom Left: Info -->
				<div
					id="left-text"
					class="space-y-3"
					style="transition: opacity 1800ms ease;"
				>
					<div
						class="flex items-center gap-3 text-[12px] font-medium tracking-widest opacity-80"
					>
						<span
							class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"
						></span>
						<p>Explore the desk. Objects are interactive.</p>
					</div>
					<div class="text-[12px] font-medium opacity-40 pt-1">
						<p>
							&copy; {new Date().getFullYear()} Sehaz &mdash; Chandigarh,
							IN
						</p>
					</div>
				</div>

				<!-- Bottom Right: Name Plate -->
				<div
					id="name-plate"
					class="name-plate text-right flex flex-col items-end cursor-crosshair drop-shadow-sm pointer-events-auto"
					style="transition: opacity 1800ms ease;"
				>
					<h1
						id="name-heading"
						class="font-serif relative text-[64px] sm:text-[90px] font-normal leading-[1.1] tracking-normal grid justify-items-end items-end h-[75px] sm:h-[105px] overflow-hidden text-[#1C1917]"
						style="transition: color 2000ms cubic-bezier(0.45,0.05,0.55,0.95);"
					>
						<span class="name-primary col-start-1 row-start-1"
							>Sehaz</span
						>
						<span
							class="name-secondary col-start-1 row-start-1 text-[#8B0000] whitespace-nowrap"
							>Sehajveer Singh</span
						>
					</h1>
					<p
						id="role-badge"
						class="text-[12px] uppercase tracking-[0.3em] font-medium mt-4 border border-stone-200 text-secondary px-4 py-2 rounded-full"
						style="transition: border-color 2000ms cubic-bezier(0.45,0.05,0.55,0.95), color 2000ms cubic-bezier(0.45,0.05,0.55,0.95);"
					>
						Full-Stack Developer
					</p>
				</div>
			</div>
		</div>

		<!-- Hotspots & Desk Image Parent container -->
		<!-- We bind the zoom scale to this div, so both the image AND the hotspots scale together flawlessly -->
		<!-- Day/Night layered background -->
		<div
			id="desk-background"
			class="hidden md:block fixed inset-0 z-0 opacity-0 animate-[fadeInOpacity_1.5s_ease-out_forwards] transition-all duration-[1200ms] ease-[cubic-bezier(0.16,1,0.3,1)]"
			style="background-color: #E2D9CE; filter: brightness(1); transition: transform 1000ms cubic-bezier(0.16,1,0.3,1), transform-origin 1000ms cubic-bezier(0.16,1,0.3,1), filter 2000ms cubic-bezier(0.45,0.05,0.55,0.95);"
		>
			<!-- Day image (always visible base) -->
			<div
				id="desk-day"
				class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-[2000ms] ease-[cubic-bezier(0.4,0,0.2,1)]"
				style="background-image: url('/desk.png');"
			>
			</div>
			<!-- Night image (fades in on top) -->
			<div
				id="desk-night"
				class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-0 transition-opacity duration-[2000ms] ease-[cubic-bezier(0.45,0.05,0.55,0.95)]"
				style="background-image: url('/desk-night.png');"
			>
			</div>

			<div class="w-full h-full relative">
				<!-- Laptop -> Projects -->
				<Hotspot
					id="hotspot-laptop"
					targetPanel="panel-projects"
					top="33%"
					left="38%"
					width="24%"
					height="24%"
				/>

				<!-- Notebook -> About -->
				<Hotspot
					id="hotspot-notebook"
					targetPanel="panel-about"
					top="48%"
					left="9%"
					width="23%"
					height="3.5%"
				/>
				<!-- Phone -> Contact -->
				<Hotspot
					id="hotspot-phone"
					targetPanel="panel-contact"
					top="65%"
					left="25%"
					width="8%"
					height="20%"
					indicatorColor="bg-white"
				/>

				<!-- Todo Note -> Working On -->
				<Hotspot
					id="hotspot-todo"
					targetPanel="panel-todo"
					top="35%"
					left="64%"
					width="6%"
					height="11%"
				/>

				<!-- Keyboard -> Easter Egg -->
				<Hotspot
					id="hotspot-keyboard"
					targetPanel="panel-fun-keyboard"
					top="67%"
					left="37%"
					width="25%"
					height="15%"
				/>

				<!-- Passive Keyboard Glow Container -->
				<div
					id="passive-keyboard-glows"
					class="absolute pointer-events-none z-10"
					style="top: 67%; left: 37%; width: 25%; height: 15%; perspective: 500px;"
				>
				</div>

				<!-- Mouse -> Easter Egg -->
				<Hotspot
					id="hotspot-mouse"
					targetPanel="panel-fun-mouse"
					top="67%"
					left="67%"
					width="5%"
					height="14%"
				/>

				<!-- Headphones -> Easter Egg -->
				<Hotspot
					id="hotspot-headphones"
					targetPanel="panel-fun-headphones"
					top="17%"
					left="75%"
					width="15%"
					height="27%"
				/>

				<!-- Coffee Mug -> Easter Egg -->
				<Hotspot
					id="hotspot-mug"
					targetPanel="panel-fun-mug"
					top="57%"
					left="76%"
					width="7%"
					height="13%"
				/>

				<!-- Lamp -> Night Mode Toggle -->
				<button
					id="hotspot-lamp"
					class="desk-hotspot absolute z-20 cursor-pointer group pointer-events-auto flex items-center justify-center opacity-0 animate-[fadeIn_1s_ease-out_forwards] animation-delay-700"
					style="top: 2%; left: 2%; width: 16%; height: 28%;"
					aria-label="Toggle night mode"
					aria-pressed="false"
				>
					<div
						class="relative flex items-center justify-center w-6 h-6 transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] group-hover:scale-150"
					>
						<span
							id="lamp-ring"
							class="absolute inline-flex w-full h-full rounded-full border border-black/20 group-hover:border-black/50 transition-colors duration-500"
						></span>
						<span
							id="lamp-dot"
							class="relative inline-flex w-1.5 h-1.5 rounded-full bg-black/40 group-hover:bg-black/80 transition-colors duration-500"
						></span>
					</div>
				</button>
			</div>
		</div>

		<!-- Mobile Fallback Content (shows static lists instead of overlay map) -->
		<div class="md:hidden p-8 space-y-12 pb-24">
			<div id="mobile-projects" class="space-y-6">
				<h2
					class="text-[24px] font-serif font-medium tracking-tight border-b border-black/10 pb-4"
				>
					Selected Work
				</h2>
				<div class="space-y-6">
					<div class="group border-b border-black/10 pb-6">
						<div class="flex items-baseline justify-between mb-2">
							<h3 class="font-serif text-[18px] font-medium">
								The Framed Archive
							</h3>
							<a
								href="https://theframedarchive.com"
								class="text-[13px] text-secondary"
								>View &rarr;</a
							>
						</div>
						<p class="text-[16px] text-secondary mb-3">
							A full-scale e-commerce platform for posters. Built
							with a responsive, premium UI/UX.
						</p>
						<div
							class="flex gap-2 text-[12px] text-secondary font-medium"
						>
							<span class="px-2 py-1 bg-black/5 rounded"
								>Next.js</span
							>
							<span class="px-2 py-1 bg-black/5 rounded"
								>Firebase</span
							>
						</div>
					</div>

					<div class="group border-b border-black/10 pb-6">
						<div class="flex items-baseline justify-between mb-2">
							<h3 class="font-serif text-[18px] font-medium">
								Folia
							</h3>
							<a
								href="https://folia-os.vercel.app"
								class="text-[13px] text-secondary"
								>View &rarr;</a
							>
						</div>
						<p class="text-[16px] text-secondary mb-3">
							A "second brain" personal productivity app designed
							for seamless knowledge organization.
						</p>
						<div
							class="flex gap-2 text-[12px] text-secondary font-medium"
						>
							<span class="px-2 py-1 bg-black/5 rounded"
								>Next.js</span
							>
							<span class="px-2 py-1 bg-black/5 rounded"
								>Supabase</span
							>
						</div>
					</div>

					<div class="group border-b border-black/10 pb-6">
						<div class="flex items-baseline justify-between mb-2">
							<h3 class="font-serif text-[18px] font-medium">
								The Open Shelf
							</h3>
							<a
								href="https://the-open-shelf.vercel.app"
								class="text-[13px] text-secondary"
								>View &rarr;</a
							>
						</div>
						<p class="text-[16px] text-secondary mb-3">
							A non-linear reading platform that replaces
							traditional RSS feeds with an infinite spatial
							canvas.
						</p>
						<div
							class="flex gap-2 text-[12px] text-secondary font-medium"
						>
							<span class="px-2 py-1 bg-black/5 rounded"
								>React</span
							>
							<span class="px-2 py-1 bg-black/5 rounded"
								>Spatial API</span
							>
						</div>
					</div>
				</div>
			</div>

			<div id="mobile-about" class="space-y-6">
				<h2
					class="text-[24px] font-serif font-medium tracking-tight border-b border-black/10 pb-4"
				>
					About Me
				</h2>
				<p class="text-[16px] text-secondary leading-relaxed">
					Hi, I'm Sehajveer Singh, a full-stack developer passionate
					about building high-performance, beautiful software. I am
					currently pursuing my Bachelor of Engineering in Computer
					Science at Chitkara University (Expected 2027).
				</p>
			</div>

			<div id="mobile-contact" class="space-y-6">
				<h2
					class="text-[24px] font-serif font-medium tracking-tight border-b border-black/10 pb-4"
				>
					Contact
				</h2>
				<ul class="space-y-4">
					<li>
						<a
							href="mailto:sehajveersingh2005@gmail.com"
							class="text-[16px] font-medium hover:text-accent flex items-center gap-3"
							><span class="w-1.5 h-1.5 rounded-full bg-accent"
							></span> sehajveersingh2005@gmail.com</a
						>
					</li>
					<li>
						<a
							href="https://github.com/SehajveerSingh2005"
							target="_blank"
							class="text-[16px] font-medium hover:text-accent flex items-center gap-3"
							><span class="w-1.5 h-1.5 rounded-full bg-accent"
							></span> GitHub</a
						>
					</li>
					<li>
						<a
							href="#"
							target="_blank"
							class="text-[16px] font-medium hover:text-accent flex items-center gap-3"
							><span class="w-1.5 h-1.5 rounded-full bg-accent"
							></span> LinkedIn</a
						>
					</li>
					<li>
						<span
							class="text-[16px] font-medium flex items-center gap-3 text-secondary"
							><span class="w-1.5 h-1.5 rounded-full bg-accent"
							></span> +91 8360138347</span
						>
					</li>
				</ul>
			</div>
			<div id="mobile-workingon" class="space-y-6">
				<h2
					class="text-[24px] font-serif font-medium tracking-tight border-b border-black/10 pb-4"
				>
					Currently Working On
				</h2>
				<p class="text-[16px] text-secondary leading-relaxed">
					Exploring spatial interfaces, WebGL depth, and brutalist
					performance optimizations.
				</p>
			</div>
		</div>
	</div>

	<!-- Overlays (Hidden on mobile via CSS or handled by JS) -->
	<div class="hidden md:block">
		<!-- Projects / Laptop -->
		<Overlay id="panel-projects">
			<ProjectsContent />
		</Overlay>

		<!-- About / Notebook -->
		<Overlay id="panel-about">
			<AboutContent />
		</Overlay>

		<!-- Contact / Phone -->
		<Overlay id="panel-contact">
			<ContactContent />
		</Overlay>

		<!-- Working On / Todo -->
		<Overlay id="panel-todo">
			<TodoContent />
		</Overlay>

		<!-- Easter Eggs -->
		<Overlay id="panel-fun-keyboard">
			<KeyboardContent />
		</Overlay>

		<Overlay id="panel-fun-mouse">
			<div class="text-center space-y-4 py-8 max-w-xs mx-auto">
				<div class="text-[48px] mb-6 grayscale opacity-80">üñ±Ô∏è</div>
				<h2 class="text-[20px] font-semibold tracking-tight">
					Precise Tracking
				</h2>
				<p class="text-[15px] text-secondary">
					The unsung hero of desktop navigation.
				</p>
			</div>
		</Overlay>

		<Overlay id="panel-fun-headphones">
			<div class="text-center space-y-4 py-8 max-w-xs mx-auto">
				<div class="text-[48px] mb-6 grayscale opacity-80">üéß</div>
				<h2 class="text-[20px] font-semibold tracking-tight">
					Focus Mode
				</h2>
				<p class="text-[15px] text-secondary">
					Lofi beats to study and relax to. Playlist integration
					coming soon.
				</p>
			</div>
		</Overlay>

		<Overlay id="panel-fun-mug">
			<div class="text-center space-y-4 py-8 max-w-xs mx-auto">
				<div class="text-[48px] mb-6 grayscale opacity-80">‚òï</div>
				<h2 class="text-[20px] font-semibold tracking-tight">
					Fancy a coffee?
				</h2>
				<p class="text-[15px] text-secondary">
					The fuel behind the code. Let's chat.
				</p>
			</div>
		</Overlay>
	</div>

	<script>
		// Centralized overlay and interaction management
		document.addEventListener("DOMContentLoaded", () => {
			const overlays = document.querySelectorAll(".overlay-panel");
			const closeBtns = document.querySelectorAll("[data-close-overlay]");
			const hotspots = document.querySelectorAll(".desk-hotspot");
			const deskBg = document.getElementById("desk-background");

			let activePanelId: string | null = null;

			// ---------- Night mode state ----------
			let isNight = sessionStorage.getItem("isNight") === "true";
			const nightLayer = document.getElementById(
				"desk-night",
			) as HTMLElement | null;
			const lampBtn = document.getElementById(
				"hotspot-lamp",
			) as HTMLElement | null;
			const lampDot = document.getElementById(
				"lamp-dot",
			) as HTMLElement | null;
			const lampRing = document.getElementById(
				"lamp-ring",
			) as HTMLElement | null;
			const uiOverlay = document.getElementById(
				"ui-overlay",
			) as HTMLElement | null;
			const nameEl = document.getElementById(
				"name-heading",
			) as HTMLElement | null;

			// Base transition string for transform (shared, keep intact)
			const BASE_TRANSITION =
				"transform 1000ms cubic-bezier(0.16,1,0.3,1), transform-origin 1000ms cubic-bezier(0.16,1,0.3,1)";
			const DEFAULT_FILTER_TRANSITION = `${BASE_TRANSITION}, filter 2000ms cubic-bezier(0.45,0.05,0.55,0.95)`;

			// Apply UI-only state (text, badge ‚Äî CSS handles their transitions)
			const applyUIState = (night: boolean) => {
				if (uiOverlay) uiOverlay.style.color = night ? "#e7d5b3" : "";
				if (nameEl) nameEl.style.color = night ? "#e7d5b3" : "";
				const badge = document.getElementById("role-badge");
				if (badge) {
					badge.style.borderColor = night
						? "rgba(231,213,179,0.25)"
						: "";
					badge.style.color = night ? "rgba(231,213,179,0.6)" : "";
				}
				if (lampBtn)
					lampBtn.setAttribute("aria-pressed", String(night));
			};

			// Snap the night layer opacity with no CSS transition (instant)
			const snapNightLayer = (opacity: string) => {
				if (!nightLayer) return;
				nightLayer.style.transition = "none";
				nightLayer.style.opacity = opacity;
				void nightLayer.offsetHeight; // force reflow
				nightLayer.style.transition = ""; // restore
			};

			// Toggle handler ‚Äî 3-phase lamp effect
			const namePlate = document.getElementById(
				"name-plate",
			) as HTMLElement | null;
			const leftText = document.getElementById(
				"left-text",
			) as HTMLElement | null;
			const textEls = [leftText, namePlate];

			// Snap text opacity (no transition ‚Äî instant)
			const snapTextOpacity = (opacity: string) => {
				textEls.forEach((el) => {
					if (!el) return;
					const saved = el.style.transition;
					el.style.transition = "none";
					el.style.opacity = opacity;
					void el.offsetHeight;
					el.style.transition = saved;
				});
			};

			// Fade text with transition
			const fadeTextOpacity = (opacity: string) => {
				textEls.forEach((el) => {
					if (el) el.style.opacity = opacity;
				});
			};

			// Apply night mode on load with a "darkness to unlit room" effect
			const applyNightInstantly = () => {
				if (!deskBg || !nightLayer) return;

				// Disable initial day-mode fade-in animations
				deskBg.style.animation = "none";
				deskBg.style.opacity = "1";
				if (uiOverlay) {
					uiOverlay.style.animation = "none";
					uiOverlay.style.opacity = "1";
				}

				// Start in deep darkness
				deskBg.style.transition = "none";
				deskBg.style.filter = "brightness(0.06) saturate(0)";
				nightLayer.style.transition = "none";
				nightLayer.style.opacity = "1";

				// Prepare UI state but keep text hidden for initial darkness
				applyUIState(true);
				textEls.forEach((el) => {
					if (el) {
						el.style.transition = "none";
						el.style.opacity = "0";
					}
				});

				// Force a reflow
				void deskBg.offsetHeight;

				// Start the "eyes adjusting" transition after a short delay
				setTimeout(() => {
					deskBg.style.transition = `filter 2500ms cubic-bezier(0.16, 1, 0.3, 1)`;
					deskBg.style.filter = "brightness(0.85) saturate(0.9)";

					textEls.forEach((el) => {
						if (el) {
							el.style.transition = "opacity 2000ms ease";
							el.style.opacity = "1";
						}
					});

					setTimeout(() => {
						deskBg.style.transition = DEFAULT_FILTER_TRANSITION;
						nightLayer.style.transition = "";
						textEls.forEach((el) => {
							if (el) el.style.transition = "";
						});
					}, 2500);
				}, 600);
			};

			if (isNight) applyNightInstantly();

			const toggleNight = () => {
				if (!deskBg) return;
				isNight = !isNight;
				sessionStorage.setItem("isNight", String(isNight));
				applyUIState(isNight);

				// GPU hint for the duration of the animation
				deskBg.style.willChange = "filter, transform";

				if (isNight) {
					// ‚îÄ‚îÄ Day ‚Üí Night ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
					// Phase 1: night falls ‚Äî dim + desaturate (colour drains as light goes)
					deskBg.style.transition = `${BASE_TRANSITION}, filter 1800ms cubic-bezier(0.4,0,0.6,1)`;
					deskBg.style.filter = "brightness(0.06) saturate(0.2)";
					fadeTextOpacity("0");

					// 1800ms dim + 250ms hold in darkness = lamp clicks at 2050ms
					setTimeout(() => {
						// Phase 2a: lamp on ‚Äî snap night image in + text back
						snapNightLayer("1");
						snapTextOpacity("1");

						// Phase 2b: instant brightness burst (no transition ‚Äî pure flash)
						deskBg.style.transition = BASE_TRANSITION;
						deskBg.style.filter = "brightness(1.5) saturate(1.1)";
						void deskBg.offsetHeight; // commit the flash

						// Phase 3: settle to warm lamp level
						requestAnimationFrame(() => {
							requestAnimationFrame(() => {
								deskBg.style.transition = `${BASE_TRANSITION}, filter 700ms cubic-bezier(0.16,1,0.3,1)`;
								deskBg.style.filter =
									"brightness(0.85) saturate(0.9)";
								setTimeout(() => {
									deskBg.style.transition =
										DEFAULT_FILTER_TRANSITION;
									deskBg.style.willChange = "auto";
								}, 700);
							});
						});
					}, 2050);
				} else {
					// ‚îÄ‚îÄ Night ‚Üí Day ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
					// Phase 1: instant lamp off ‚Äî snap to cold dark, no transition
					deskBg.style.transition = BASE_TRANSITION;
					deskBg.style.filter = "brightness(0.06) saturate(0)";
					void deskBg.offsetHeight; // commit instantly
					snapTextOpacity("0");

					// Brief hold ‚Äî lamp-off moment
					setTimeout(() => {
						// Phase 2: invisibly swap to day image while fully dark
						snapNightLayer("0");

						// Phase 3: dawn ‚Äî slow ease-in so it barely moves at first
						// then accelerates like the sun cresting the horizon
						// Colour warms and saturates as brightness rises
						deskBg.style.transition = `${BASE_TRANSITION}, filter 3000ms cubic-bezier(0.6,0,0.8,1)`;
						deskBg.style.filter = "brightness(1) saturate(1)";

						// Text reappears mid-rise when there's enough light (aligned to 3s)
						setTimeout(() => snapTextOpacity("1"), 1500);

						// Cleanup
						setTimeout(() => {
							deskBg.style.transition = DEFAULT_FILTER_TRANSITION;
							deskBg.style.willChange = "auto";
						}, 3000);
					}, 300);
				}
			};

			if (lampBtn) {
				lampBtn.addEventListener("click", toggleNight);
			}
			// ---------- End night mode ----------

			// Function to close all overlays
			const closeAllOverlays = () => {
				overlays.forEach((overlay) =>
					overlay.classList.remove("active"),
				);
				activePanelId = null;
				if (deskBg) {
					deskBg.style.transform = "";
				}
			};

			// Function to open specific overlay
			const openOverlay = (
				targetId: string,
				originX?: string,
				originY?: string,
			) => {
				closeAllOverlays();
				const panel = document.getElementById(targetId);
				if (panel) {
					panel.classList.add("active");
					activePanelId = targetId;
					if (deskBg && originX && originY) {
						deskBg.style.transformOrigin = `${originX} ${originY}`;
						deskBg.style.transform = "scale(1.15)";
					}
				}
			};

			// Glide between hotspots: debounce the zoom-out so moving from one
			// hotspot to another just shifts the origin instead of zoom out ‚Üí zoom in
			let leaveTimeout: ReturnType<typeof setTimeout> | null = null;

			// Attach hotspot clicks (exclude lamp which handles its own logic)
			hotspots.forEach((hotspot) => {
				if (hotspot.id === "hotspot-lamp") return;

				hotspot.addEventListener("click", (e) => {
					const el = e.currentTarget as HTMLElement;
					const target = el.getAttribute("data-target");
					const left = el.style.left || "50%";
					const top = el.style.top || "50%";
					if (target) openOverlay(target, left, top);
				});

				hotspot.addEventListener("mouseenter", (e) => {
					if (activePanelId || !deskBg) return;

					// Cancel any pending zoom-out ‚Äî just glide the origin
					if (leaveTimeout) {
						clearTimeout(leaveTimeout);
						leaveTimeout = null;
					}

					const el = e.currentTarget as HTMLElement;
					deskBg.style.transformOrigin = `${el.style.left} ${el.style.top}`;
					deskBg.style.transform = "scale(1.15)";
				});

				hotspot.addEventListener("mouseleave", () => {
					if (!activePanelId && deskBg) {
						leaveTimeout = setTimeout(() => {
							if (!activePanelId && deskBg) {
								deskBg.style.transform = "";
							}
							leaveTimeout = null;
						}, 80);
					}
				});
			});

			// Desktop specific: we can also wire Esc and backdrop clicks
			closeBtns.forEach((btn) => {
				btn.addEventListener("click", closeAllOverlays);
			});

			// Escape key to close
			document.addEventListener("keydown", (e) => {
				if (e.key === "Escape" && activePanelId) {
					closeAllOverlays();
				}
			});

			/* ‚îÄ‚îÄ‚îÄ PASSIVE KEYBOARD INTERACTION ‚îÄ‚îÄ‚îÄ */
			const keyGlows = document.getElementById("passive-keyboard-glows");
			const BASE = "/sounds/nk-cream";
			const LETTER_SOUNDS = {
				a: `${BASE}/a.wav`,
				e: `${BASE}/e.wav`,
				i: `${BASE}/i.wav`,
				o: `${BASE}/o.wav`,
				s: `${BASE}/s.wav`,
				t: `${BASE}/t.wav`,
			};
			const FALLBACK_POOL = [
				`${BASE}/a.wav`,
				`${BASE}/e.wav`,
				`${BASE}/s.wav`,
				`${BASE}/t.wav`,
				`${BASE}/i.wav`,
				`${BASE}/o.wav`,
			];
			const SPACE_SND = `${BASE}/space.wav`;
			const BACKSPACE_SND = `${BASE}/backspace.wav`;
			const ENTER_SND = `${BASE}/enter.wav`;

			let audioCtx: AudioContext | null = null;
			const bufferCache = new Map<string, AudioBuffer>();
			let fallbackIdx = 0;

			async function getCtx(): Promise<AudioContext> {
				if (!audioCtx) audioCtx = new AudioContext();
				if (audioCtx.state === "suspended") await audioCtx.resume();
				return audioCtx;
			}

			async function loadBuffer(
				url: string,
			): Promise<AudioBuffer | null> {
				if (bufferCache.has(url)) return bufferCache.get(url)!;
				try {
					const ctx = await getCtx();
					const res = await fetch(url);
					const arr = await res.arrayBuffer();
					const buf = await ctx.decodeAudioData(arr);
					bufferCache.set(url, buf);
					return buf;
				} catch {
					return null;
				}
			}

			function playPassiveKey(key: string) {
				const pitch = 0.97 + Math.random() * 0.06;
				let url = "";
				if (key === " ") url = SPACE_SND;
				else if (key === "Backspace") url = BACKSPACE_SND;
				else if (key === "Enter") url = ENTER_SND;
				else {
					const lower = key.toLowerCase();
					url =
						(LETTER_SOUNDS as Record<string, string>)[lower] ??
						FALLBACK_POOL[fallbackIdx++ % FALLBACK_POOL.length];
				}

				loadBuffer(url).then((buf) => {
					if (!buf) return;
					getCtx().then((ctx) => {
						const src = ctx.createBufferSource();
						src.buffer = buf;
						src.playbackRate.value = pitch;
						const gain = ctx.createGain();
						gain.gain.value = 0.45; // Quieter for background ambiance
						src.connect(gain);
						gain.connect(ctx.destination);
						src.start();
					});
				});
			}

			// Map layout based on 25% width, 15% height bounds of keyboard.
			// 65% keyboard roughly: 16 cols (6.25% each), 5 rows (20% each)
			const KMAP: Record<string, { r: number; c: number; w: number }> = {
				"`": { r: 0, c: 0, w: 1 },
				"1": { r: 0, c: 1, w: 1 },
				"2": { r: 0, c: 2, w: 1 },
				"3": { r: 0, c: 3, w: 1 },
				"4": { r: 0, c: 4, w: 1 },
				"5": { r: 0, c: 5, w: 1 },
				"6": { r: 0, c: 6, w: 1 },
				"7": { r: 0, c: 7, w: 1 },
				"8": { r: 0, c: 8, w: 1 },
				"9": { r: 0, c: 9, w: 1 },
				"0": { r: 0, c: 10, w: 1 },
				"-": { r: 0, c: 11, w: 1 },
				"=": { r: 0, c: 12, w: 1 },
				backspace: { r: 0, c: 13, w: 2 },
				tab: { r: 1, c: 0, w: 1.5 },
				q: { r: 1, c: 2, w: 1 },
				w: { r: 1, c: 3, w: 1 },
				e: { r: 1, c: 3.75, w: 1 },
				r: { r: 1, c: 4.75, w: 1 },
				t: { r: 1, c: 5.75, w: 1 },
				y: { r: 1, c: 6.75, w: 1 },
				u: { r: 1, c: 7.75, w: 1 },
				i: { r: 1, c: 8.5, w: 1 },
				o: { r: 1, c: 9.5, w: 1 },
				p: { r: 1, c: 10.5, w: 1 },
				"[": { r: 1, c: 11.5, w: 1 },
				"]": { r: 1, c: 12.5, w: 1 },
				"\\": { r: 1, c: 13.5, w: 1.5 },
				capslock: { r: 2, c: 0.5, w: 1.75 },
				a: { r: 2, c: 2.10, w: 1 },
				s: { r: 2, c: 3, w: 1 },
				d: { r: 2, c: 4, w: 1 },
				f: { r: 2, c: 5, w: 1 },
				g: { r: 2, c: 6, w: 1 },
				h: { r: 2, c: 7, w: 1 },
				j: { r: 2, c: 7.75, w: 1 },
				k: { r: 2, c: 8.75, w: 1 },
				l: { r: 2, c: 9.75, w: 1 },
				";": { r: 2, c: 10.75, w: 1 },
				"'": { r: 2, c: 11.75, w: 1 },
				enter: { r: 2, c: 12.75, w: 2.25 },
				shift: { r: 2.8, c: 0.5, w: 2.25 },
				z: { r: 3, c: 2.5, w: 1 },
				x: { r: 3, c: 3.5, w: 1 },
				c: { r: 3, c: 4.5, w: 1 },
				v: { r: 3, c: 5.5, w: 1 },
				b: { r: 3, c: 6.5, w: 1 },
				n: { r: 3, c: 7.5, w: 1 },
				m: { r: 3, c: 8.25, w: 1 },
				",": { r: 3, c: 9.25, w: 1 },
				".": { r: 3, c: 10.25, w: 1 },
				"/": { r: 3, c: 11.25, w: 1 },
				arrowup: { r: 3, c: 14.15, w: 1 },
				control: { r: 3.75, c: 0.5, w: 1.25 },
				meta: { r: 4, c: 1.25, w: 1.25 },
				alt: { r: 3.75, c: 2.75, w: 1.25 },
				" ": { r: 3.75, c: 3.65, w: 7.25 },
				arrowleft: { r: 3.75, c: 13.25, w: 1 },
				arrowdown: { r: 3.75, c: 14.15, w: 1 },
				arrowright: { r: 3.75, c: 15, w: 1 },
			};

			document.addEventListener("keydown", (e) => {
				// Ignore if a panel is active or typing in an input/textarea
				if (activePanelId) return;
				const tag = document.activeElement?.tagName.toLowerCase();
				if (tag === "input" || tag === "textarea") return;

				const keyName = e.key.toLowerCase();

				// Only interact if it's a visible key or mapped
				if (keyName.length === 1 || KMAP[keyName]) {
					playPassiveKey(e.key);
				}

				const mapData = KMAP[keyName];
				if (mapData && keyGlows) {
					const glow = document.createElement("div");

					// Use inline styles to bypass Tailwind JIT purging on dynamic elements
					glow.style.position = "absolute";
					glow.style.backgroundColor = "rgba(255, 255, 255, 0.6)";
					glow.style.borderRadius = "4px";
					glow.style.pointerEvents = "none";
					glow.style.zIndex = "10";
					glow.style.transition =
						"all 500ms cubic-bezier(0.16, 1, 0.3, 1)";

					const left = mapData.c * 6.25;
					const top = mapData.r * 20;
					const width = mapData.w * 6.25 * 0.9; // 90% of bounding box for margin
					const height = 18 * 0.9; // 90% of row height

					glow.style.left = `${left + mapData.w * 6.25 * 0.05}%`; // center margin
					glow.style.top = `${top + 20 * 0.05}%`;
					glow.style.width = `${width}%`;
					glow.style.height = `${height}%`;

					// Initial active un-transitioned state (Key pressed DOWN state)
					glow.style.opacity = "1";
					glow.style.transform = "translateY(1.5px) scale(0.96)";
					glow.style.boxShadow =
						"0 0 24px 10px rgba(255, 255, 255, 0.5), inset 0px 4px 6px rgba(0,0,0,0.4)";

					keyGlows.appendChild(glow);

					// Define key released UP state
					setTimeout(() => {
						glow.style.opacity = "0";
						glow.style.transform = "translateY(-1px) scale(1.04)";
						glow.style.boxShadow =
							"0 0 45px 18px rgba(255, 255, 255, 0), inset 0px -2px 4px rgba(0,0,0,0)";
					}, 50); // Keep it "pressed" for a fraction of a second

					setTimeout(() => {
						glow.remove();
					}, 600); // Buffer after transition
				}
			});
		});
	</script>

	<style>
		/* Name plate slide animation ‚Äî plain CSS, no Tailwind group-hover needed */
		.name-primary {
			transform: translateY(0);
			opacity: 1;
			transition:
				transform 700ms cubic-bezier(0.16, 1, 0.3, 1),
				opacity 700ms cubic-bezier(0.16, 1, 0.3, 1);
		}
		.name-plate:hover .name-primary {
			transform: translateY(-100%);
			opacity: 0;
		}

		.name-secondary {
			transform: translateY(100%);
			opacity: 0;
			transition:
				transform 700ms cubic-bezier(0.16, 1, 0.3, 1),
				opacity 700ms cubic-bezier(0.16, 1, 0.3, 1);
		}
		.name-plate:hover .name-secondary {
			transform: translateY(0);
			opacity: 1;
		}
	</style>
</Layout>
